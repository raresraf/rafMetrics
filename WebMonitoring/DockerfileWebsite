FROM ubuntu:trusty

# Install Chrome debian sources
RUN apt-get update \
    && apt-get install -y wget \
    && apt-get clean \
    && wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add - \
    && echo "deb http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list

# Chromedriver extra libraries
RUN apt-get install -y libglib2.0-0=2.50.3-2 \
    libnss3=2:3.26.2-1.1+deb9u1 \
    libgconf-2-4=3.2.6-4+b1 \
    libfontconfig1=2.11.0-6.7+b1

# Install pptitude and python dependencies
RUN apt-get update \
    && apt-get install -y xvfb python-pip unzip openjdk-7-jre google-chrome-stable \
    && apt-get clean \
    && pip install selenium browsermob-proxy xvfbwrapper --upgrade

# Install direct binary dependencies
RUN wget https://github.com/lightbody/browsermob-proxy/releases/download/browsermob-proxy-2.1.2/browsermob-proxy-2.1.2-bin.zip \
    && unzip browsermob-proxy-2.1.2-bin.zip \
    && wget http://selenium-release.storage.googleapis.com/2.41/selenium-server-standalone-2.41.0.jar \
    && wget https://chromedriver.storage.googleapis.com/2.25/chromedriver_linux64.zip \
    && unzip chromedriver_linux64.zip \
    && chmod +x chromedriver

# Start selenium server
RUN mkdir -p /log \
    && /usr/bin/java -jar selenium-server-standalone-2.41.0.jar >> /log/selenium.$(date +"%Y%d%m").log 2>&1&


RUN apt-get update && apt-get -y dist-upgrade

RUN apt-get install -y python3
RUN apt-get install -y ipython3
RUN apt-get install -y python3-pip
RUN apt-get install -y mysql-server
RUN pip3 install mysql-connector-python
RUN pip3 install requests
RUN pip3 install arrow

COPY . /rafMetrics
WORKDIR /rafMetrics

RUN chmod u+x ./WebMonitoring/WebsiteMonitorHelpers/entrypoint.sh

# Execute Website management
ENV PYTHONPATH="/rafMetrics"
ENTRYPOINT ["python3", "./WebMonitoring/WebsiteManager.py"]

# For development purpose only
# ENTRYPOINT ["tail", "-f", "/dev/null"]

